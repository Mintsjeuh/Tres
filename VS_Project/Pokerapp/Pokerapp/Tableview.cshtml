@using WebMatrix.Data

@{
    Layout = "~/_Layout.cshtml";	
    Page.Title = "Select Game";

    string connectionString = @"Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Database.mdf;Integrated Security=True";
    string provider = "System.Data.SqlClient";
    Database db = Database.OpenConnectionString(connectionString, provider);

    string url = Request.Url.AbsolutePath;
    string[] urlcode = url.Split('/');
    int roomCode = Request["roomcode"].AsInt();
    int table = Request["table"].AsInt();
    var namen = db.Query("SELECT Name FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1", roomCode, table);
    int aantal = namen.Count();
    double gedeeld = aantal / 2;
    int helft = Convert.ToInt32(gedeeld);
    int eerste = Convert.ToInt32(aantal - helft);
    int tweede = Convert.ToInt32(eerste - 1);
    if (aantal % 2 == 0)
    {
        tweede = eerste;
    }
    if (aantal > 10)    //Haal max spelers uit database
    {
         string Url = "Players.cshtml/" + roomCode;
        Response.Redirect("~/" + Url);
    }


    if (IsPost && !Request["blindnext"].IsEmpty())
    {
        int current_Round = db.QueryValue("SELECT Blind_Round FROM Room WHERE Room_Code = @0", roomCode);
        int new_Round = current_Round + 1;
        db.Execute("UPDATE Room SET Blind_Round = @0 WHERE Room_Code = @1", new_Round, roomCode);
        <script>
            //$(document).ready(function() {
                alert("The blind has been raised!");
            //})
        </script>
    }
    int id = db.QueryValue("SELECT Blind_Round FROM Room WHERE Room_Code = @0", roomCode);	
    var blind_id = db.Query("SELECT Top (@0) ID FROM Blinds WHERE Room_Code = @1 ORDER BY ID ASC", id, roomCode);
    int min_size = db.QueryValue("SELECT Tbl_Min_Size FROM Room WHERE Room_Code = @0", roomCode);
    var small_blind = db.Query("SELECT TOP (@0) Value FROM Blinds WHERE Room_Code = @1 AND S_B = 's' ORDER BY ID ASC", id, roomCode);
    int small = 0;	
    foreach (var a in small_blind)	
    {	
        if (a.Value > small)	
        {	
            small = a.Value;	
        }	
    }	
    var big_blind = db.Query("SELECT TOP (@0) Value FROM Blinds WHERE Room_Code = @1 AND S_B = 'b' ORDER BY ID ASC", id, roomCode);	
    int big = 0;	
    foreach (var a in big_blind)	
    {	
        if (a.Value > big)	
        {	
            big = a.Value;	
        }	
    }	

     db.Execute("UPDATE Room SET Small_Blind = @0, Big_Blind = @1 WHERE Room_Code = @2", small, big, roomCode);	
    int players = db.QueryValue("SELECT COUNT(Name) FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1", roomCode, table);	
        if (min_size >= players)	
        {	
            <script>	
                alert("The minimum size has been reached!");	
            </script>	
            Shuffle shuffle = new Shuffle();	
            shuffle.ShuffleTable(db, roomCode);	
            string Url = "Players.cshtml/" + roomCode;	
            Response.Redirect("~/" + Url);	
        }	
}


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>


    <div id="roomcode" style="display:none;">@roomCode</div>
    <div id="table" style="display:none;">@table</div>

    <div name="timer" class="timer"></div>
    <div class="round">This is round: <span id="rnumber"></span></div>

    <h1>Table @table</h1>
    <br />
    <div>
        @foreach (var a in db.Query("SELECT TOP (@0) Name FROM Players WHERE Room_Code = @1 AND Tbl_nr = @2 ORDER BY Name ASC", eerste, roomCode, table))
        {
            @a.Name
            <img src="~/stoel.png" name="chair" />
        }
    </div><br />
    <div>
        <img src="~/tafel.png" name="pokertable" />
    </div>
    <br />
    <div>
        @foreach (var a in db.Query("SELECT TOP (@2) Name FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 ORDER BY Name DESC", roomCode, table, tweede))
        {
            <img src="~/stoel.png" name="chair" />
            @a.Name
        }
    </div>

    <form method="post">	
        <input type="submit" name="blindnext" value="Raise_Blind" />	
    </form>	
    <h2>Small blind: @small</h2>	
    <h2>Big blind: @big</h2>	

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/RunTimer.js"></script>