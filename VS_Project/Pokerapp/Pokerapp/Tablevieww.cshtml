@using WebMatrix.Data

@{
    Layout = "~/_Layout.cshtml";
    string connectionString = @"Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Database.mdf;Integrated Security=True";
    string provider = "System.Data.SqlClient";
    Database db = Database.OpenConnectionString(connectionString, provider);

    string url = Request.Url.AbsolutePath;
    //string urlcode = url.Substring(url.Length - 7);
    int urlcode = 1234567;

    //int table = Convert.ToInt32(Session["tablenumber"]);
    int table = 2;

    var namen = db.Query("SELECT Name FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1", urlcode, table);
    int aantal = db.QueryValue("SELECT COUNT(Name) FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1", urlcode, table);
    double gedeeld = aantal / 2;
    int helft = Convert.ToInt32(gedeeld);
    int eerste = Convert.ToInt32(aantal - helft);
    int tweede = Convert.ToInt32(eerste - 1);
    if (aantal % 2 == 0)
    {
        tweede = eerste;
    }
    if (aantal > 10)    //Haal max spelers uit database
    {
        string Url = "Players.cshtml/" + urlcode;   //Needs fixing
        Response.Redirect("~/" + Url);
    }

    int maxrebuy = (int)db.QueryValue("SELECT Allow_Rebuy FROM Room WHERE Room_Code = @0", urlcode);


    if (IsPost && !Request.Form["quit"].IsEmpty())
    {
        int endgamequeryplayers = (int)db.Execute("UPDATE Players SET Tbl_nr = NULL, Rebuy = NULL, Active = NULL WHERE Room_Code = @0", urlcode);
        int endbamequeryroom = (int)db.Execute("UPDATE Room SET Started = 0, Round_Time = '00:00:00', Pause_Time = '00:00:00' WHERE Room_Code = @0", urlcode);

        Response.Redirect("end.cshtml");

    }


}


    <h1>Table @table</h1>
    <br />
    <div id="urlcode" style="display:none;">@urlcode</div>

    <div class="timer"></div>
    <div class="round">This is round: <span id="rnumber"></span></div>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">QUIT GAME</button>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Are you sure you want to end the game?</h5>
                </div>
                <form method="post" name="optionsform" class="optionsform">
                    <div class="modal-footer">
                        <button onclick="stopTimer();" value="quit" name="quit" type="submit">CONFIRM</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
    <div id="activebody">
        <div>
            @foreach (var a in db.Query("SELECT TOP (@0) Name, Rebuy FROM Players WHERE Room_Code = @1 AND Tbl_nr = @2 AND Active = 1 ORDER BY Name ASC", eerste, urlcode, table, eerste))
            {


                string player = (string)db.QueryValue("SELECT Name FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", a.Name, urlcode, table);
                string gaanmetdiebanaan = player + urlcode;

                <!-- Button trigger modal -->
                <button id="pokerstool" value="@player" name="player" type="button" data-toggle="modal" data-target="#@gaanmetdiebanaan">@player</button>



                int rebuyyy = (int)db.QueryValue("SELECT Rebuy FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", player, urlcode, table);



                <!-- Modal -->
                <div class="modal fade" id="@gaanmetdiebanaan" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Options for: @player</h5>
                            </div>

                            <div class="modal-body">
                                @*<form method ="post" name="optionsform" class="optionsform">*@
                                <div class="options-form-popup" id="player-options">
                                    <button type="submit" id="rebuy" onclick="updaterebuys('@player')" value="@player" name="rebuy" data-dismiss="modal">Rebuy</button>

                                </div>
                                <div>
                                    <button value="@player" name="delete" onclick="deleteplayer('@player')" data-dismiss="modal">Delete</button>
                                    @Html.Hidden("sender", player)
                                </div>
                                @*</form>*@
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you are now at @rebuyyy / @maxrebuy rebuys.</h5></div>
                            </div>

                        </div>
                    </div>
                </div>

            }


        </div>


        <br />
        <div>
            <img id="pokertable" class="table" src="~/assets/Tableview/Pokertable.png" />
        </div>
        <br />
        @foreach (var a in db.Query("SELECT TOP (@2) Name, Rebuy FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1 ORDER BY Name DESC", urlcode, table, tweede, tweede))
        {

            string player = (string)db.QueryValue("SELECT Name FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", a.Name, urlcode, table);
            string gaanmetdiebanaan = player + urlcode;

            <!-- Button trigger modal -->
            <button id="pokerstool" value="@player" name="player" type="button" data-toggle="modal" data-target="#@gaanmetdiebanaan">@player</button>


            int rebuyyy = (int)db.QueryValue("SELECT Rebuy FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", player, urlcode, table);



            <!-- Modal -->
            <div class="modal fade" id="@gaanmetdiebanaan" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Options for: @player</h5>
                        </div>

                        <div class="modal-body">
                            @*<form method ="post" name="optionsform" class="optionsform">*@
                            <div class="options-form-popup" id="player-options">
                                <button type="submit" id="rebuy" onclick="updaterebuys('@player')" value="@player" name="rebuy" data-dismiss="modal">Rebuy</button>

                            </div>
                            <div>
                                <button value="@player" name="delete" onclick="deleteplayer('@player')" data-dismiss="modal">Delete</button>
                                @Html.Hidden("sender", player)
                            </div>
                            @*</form>*@
                        </div>
                        <div class="modal-footer">
                            <div id="@player"><h5>@player you are now at @rebuyyy / @maxrebuy rebuys.</h5></div>
                        </div>

                    </div>
                </div>
            </div>
        }
    </div>

    <div id="inactivebody">
        @foreach (var pirnp in db.Query("SELECT Name FROM Players WHERE Active = 0 AND Room_Code = @0 AND Rebuy = @1 ORDER BY Name ASC", urlcode, maxrebuy))
        {
            <h3>@pirnp.Name</h3>
        }

        @foreach (var pirp in db.Query("SELECT Name, Rebuy FROM Players WHERE Room_Code = @0 AND Active = 0 AND Rebuy < @1 ORDER BY Name DESC", urlcode, maxrebuy))
        {
            int rebuyyy = (int)db.QueryValue("SELECT Rebuy FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", pirp.Name, urlcode, table);
            string player = pirp.Name;
            string test2 = player + urlcode;
            <h2>@player</h2>
            <form method="post">
                <button value="@player" name="player" type="button" class="btn btn-primary" data-toggle="modal" data-target="#@test2">Options</button>
            </form>

            <!-- Modal -->
            <div class="modal fade" id="@test2" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Options for: @player</h5>
                        </div>

                        <div class="modal-body">
                            @*<form method="post" name="optionsform" class="optionsform">*@
                            <div class="options-form-popup" id="player-options">
                                <button value="rebuy" name="rebuy" onclick="updaterebuys('@player')" type="submit" data-dismiss="modal">Rebuy</button>
                                @Html.Hidden("sender", player)
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you are now at @rebuyyy / @maxrebuy rebuys.</h5></div>
                            </div>
                            @*</form>*@
                        </div>

                    </div>
                </div>
            </div>


        }
    </div>






    <script src="https://code.jquery.com/jquery-3.3.1.js"
            integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        //function test() {console.log("test"); }
        //function loadrebuys(player) {
        //    $.get("delete-ajax.cshtml?Name=" + player, function (data, status) {
        //        console.log(data)
        //        document.getElementById("demo").innerHTML = data;
        //    });
        //}

        function updaterebuys(player) {
            $.get("tableviewrebuy.cshtml?Name=" + player, function (data, status) {
                console.log(data)
                document.getElementById(player).innerHTML = data;
                $.get("refreshinactivebody.cshtml?Name=" + player, function (data, status) {
                    document.getElementById("inactivebody").innerHTML = data;
                    $.get("rebuynotactive.cshtml?Name=" + player, function (data, status) {
                        document.getElementById("activebody").innerHTML = data;
                    });
                });
            });


        }

        function deleteplayer(player) {

            $.get("delete-ajax.cshtml?Name=" + player, function (data, status) {
                console.log(data)
                document.getElementById(player).innerHTML = data;
                $.get("refreshinactivebody.cshtml?Name=" + player, function (data, status) {
                    document.getElementById("inactivebody").innerHTML = data;
                    $.get("rebuynotactive.cshtml?Name=" + player, function (data, status) {
                        document.getElementById("activebody").innerHTML = data;
                    });
                });
            });




        }
    </script>


