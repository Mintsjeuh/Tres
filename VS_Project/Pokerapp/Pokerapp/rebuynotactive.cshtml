@using WebMatrix.Data

@{
    Layout = "_Layout.cshtml";
    string connectionString = @"Data Source=(LocalDB)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\Database.mdf;Integrated Security=True";
    string provider = "System.Data.SqlClient";
    Database db = Database.OpenConnectionString(connectionString, provider);

    string url = Request.Url.AbsolutePath;
    //string roomCode = url.Substring(url.Length - 7);

    //get name and roomcode
    string playerName = Request["name"];
    int roomCode = Convert.ToInt32(Request["roomcode"]);

    int table = db.QueryValue("SELECT Tbl_nr FROM Players WHERE Name = @0 AND Room_Code = @1", playerName, roomCode);

    var names = db.Query("SELECT Name FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1", roomCode, table);
    int amount = db.QueryValue("SELECT COUNT(Name) FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1", roomCode, table);
    double division = amount / 2;
    int halfnamesCount = Convert.ToInt32(division);
    int firsthalfnamesCount = Convert.ToInt32(amount - halfnamesCount);
    int secondhalfnamesCount = Convert.ToInt32(firsthalfnamesCount - 1);
    if (amount % 2 == 0)
    {
        secondhalfnamesCount = firsthalfnamesCount;
    }
    if (amount > 10)    //Haal max spelers uit database
    {
        string Url = "Players.cshtml/" + roomCode;   //Needs fixing
        Response.Redirect("~/" + Url);
    }

    int maxrebuy = (int)db.QueryValue("SELECT Allow_Rebuy FROM Room WHERE Room_Code = @0", roomCode);
    db.Query("SELECT Name FROM Players WHERE Active = 1 AND Room_Code = @0", roomCode);
    //string playerName = Request["Name"];

}

<div class="gridd" id="activebody" style="text-align: center; max-height:500px; max-width:800px;">

    <div class="white"></div>
    <div class="white2"></div>
    <div class="white3"></div>
    <div class="white4"></div>
    <div class="tabloo" style=" height:auto; width:auto">
        <img src="~/assets/Tableview/Pokertable.png" style="height: 100%; width: 100%; object-fit: contain" />
    </div>
    <div class="gridRow1">
        @foreach (var a in db.Query("SELECT TOP (@0) Name FROM Players WHERE Room_Code = @1 AND Tbl_nr = @2 AND Active = 1 ORDER BY Name ASC", firsthalfnamesCount, roomCode, table))
        {

            string player = (string)db.QueryValue("SELECT Name FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", a.Name, roomCode, table);
            string activeuniqueModal = player + roomCode;

            <!-- Button trigger modal -->
            <button id="pokerstool" value="@player" name="player" type="button" data-toggle="modal" data-target="#@activeuniqueModal">@player</button>

            int rebuy = (int)db.QueryValue("SELECT Rebuy FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", player, roomCode, table);

            <!-- Modal -->
            <div class="modal fade" id="@activeuniqueModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Options for: @player</h5>
                        </div>
                        @if (rebuy < maxrebuy)
                        {
                            <div class="modal-body">
                                <div class="options-form-popup" id="player-options">
                                    <button value="@player" type="submit" id="rebuy" onclick="updaterebuys('@player', '@roomCode', '@table')" name="rebuy" data-dismiss="modal">Rebuy</button>
                                </div>
                                <div>
                                    <button value="@player" name="delete" onclick="deleteplayer('@player', '@roomCode', '@table')" data-dismiss="modal">Delete</button>
                                    @Html.Hidden("sender", player)
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you are now at @rebuy / @maxrebuy rebuys.</h5></div>
                            </div>
                        }
                        @if (rebuy == maxrebuy)
                        {
                            <div class="modal-body">
                                <div>
                                    <button value="@player" name="delete" onclick="deleteplayer('@player', '@roomCode', '@table')" data-dismiss="modal">Delete</button>
                                    @Html.Hidden("sender", player)
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you have reached the maximium of @maxrebuy rebuys.</h5></div>
                            </div>
                        }

                    </div>
                </div>
            </div>
        }
    </div>
    <div class="gridRow2">
        @foreach (var a in db.Query("SELECT TOP (@2) Name FROM Players WHERE Room_Code = @0 AND Tbl_nr = @1 AND Active = 1 ORDER BY Name DESC", roomCode, table, secondhalfnamesCount))
        {

            string player = (string)db.QueryValue("SELECT Name FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", a.Name, roomCode, table);
            string activeuniqueModal = player + roomCode;

            <!-- Button trigger modal -->
            <button id="pokerstool" value="@player" name="player" type="button" data-toggle="modal" data-target="#@activeuniqueModal">@player</button>

            int rebuy = (int)db.QueryValue("SELECT Rebuy FROM Players WHERE Name = @0 AND Room_Code = @1 AND Tbl_nr = @2", player, roomCode, table);

            <!-- Modal -->
            <div class="modal fade" id="@activeuniqueModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Options for: @player</h5>
                        </div>
                        @if (rebuy < maxrebuy)
                        {
                            <div class="modal-body">
                                <div class="options-form-popup" id="player-options">
                                    <button value="@player" type="submit" id="rebuy" onclick="updaterebuys('@player', '@roomCode', '@table')" name="rebuy" data-dismiss="modal">Rebuy</button>
                                </div>
                                <div>
                                    <button value="@player" name="delete" onclick="deleteplayer('@player', '@roomCode', '@table')" data-dismiss="modal">Delete</button>
                                    @Html.Hidden("sender", player)
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you are now at @rebuy / @maxrebuy rebuys.</h5></div>
                            </div>
                        }
                        @if (rebuy == maxrebuy)
                        {
                            <div class="modal-body">
                                <div>
                                    <button value="@player" name="delete" onclick="deleteplayer('@player', '@roomCode', '@table')" data-dismiss="modal">Delete</button>
                                    @Html.Hidden("sender", player)
                                </div>
                            </div>
                            <div class="modal-footer">
                                <div id="@player"><h5>@player you have reached the maximium of @maxrebuy rebuys.</h5></div>
                            </div>
                        }

                    </div>
                </div>
            </div>

        }
    </div>
</div>